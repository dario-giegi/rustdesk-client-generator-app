name: Build RustDesk Client (Final v2)

on:
  workflow_dispatch:
    inputs:
      config_json:
        description: 'Configuration JSON'
        required: true
        type: string
      executable_name:
        description: 'Executable name'
        required: true
        type: string
        default: 'rustdesk-custom'
      rustdesk_branch:
        description: 'RustDesk branch'
        required: false
        type: string
        default: 'master'
      target_arch:
        description: 'Target architecture'
        required: false
        type: choice
        options:
          - x86_64
          - aarch64
        default: 'x86_64'
      enable_portable:
        description: 'Enable portable mode'
        required: false
        type: boolean
        default: false
      include_installer:
        description: 'Include installer (alias for create_installer)'
        required: false
        type: boolean
        default: true
      create_installer:
        description: 'Create installer'
        required: false
        type: boolean
        default: true
      enable_debug:
        description: 'Enable debug mode'
        required: false
        type: boolean
        default: false
      # Branding options
      company_name:
        description: 'Company name for branding'
        required: false
        type: string
        default: ''
      logo_url:
        description: 'Logo URL for branding'
        required: false
        type: string
        default: ''
      support_url:
        description: 'Support URL'
        required: false
        type: string
        default: ''
      # Build options
      version:
        description: 'Application version'
        required: false
        type: string
        default: '1.0.0'
      sign_executable:
        description: 'Sign the executable'
        required: false
        type: boolean
        default: false
      # Advanced options
      custom_stun_servers:
        description: 'Custom STUN servers'
        required: false
        type: string
        default: ''
      disable_tcp_tunneling:
        description: 'Disable TCP tunneling'
        required: false
        type: boolean
        default: false
      enable_hardware_acceleration:
        description: 'Enable hardware acceleration'
        required: false
        type: boolean
        default: true
      auto_update_url:
        description: 'Auto update URL'
        required: false
        type: string
        default: ''

env:
  RUST_VERSION: 1.75
  LLVM_VERSION: 15.0
  VCPKG_COMMIT_ID: 6f29f12e82a8293156836ad81cc9bf5af41fe836

jobs:
  build-windows:
    name: Build RustDesk for Windows
    runs-on: windows-2022
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      
    - name: Checkout RustDesk
      uses: actions/checkout@v4
      with:
        repository: rustdesk/rustdesk
        ref: ${{ inputs.rustdesk_branch }}
        submodules: recursive
        path: rustdesk
        
    - name: Install LLVM and Clang
      uses: KyleMayes/install-llvm-action@v1
      with:
        version: ${{ env.LLVM_VERSION }}
        
    - name: Install Rust toolchain
      uses: dtolnay/rust-toolchain@v1
      with:
        toolchain: ${{ env.RUST_VERSION }}
        targets: x86_64-pc-windows-msvc
        components: "rustfmt"
        
    - uses: Swatinem/rust-cache@v2
      with:
        prefix-key: windows-2022
        workspaces: "rustdesk -> target"
        
    - name: Setup vcpkg with Github Actions binary cache
      uses: lukka/run-vcpkg@v11
      with:
        vcpkgDirectory: C:\vcpkg
        vcpkgGitCommitId: ${{ env.VCPKG_COMMIT_ID }}
        doNotCache: false
        
    - name: Install system dependencies
      shell: powershell
      run: |
        Write-Host "=== Installing system dependencies ==="
        choco install nsis -y --no-progress
        Write-Host "[SUCCESS] System dependencies installed"
        
    - name: Setup vcpkg environment
      shell: powershell
      run: |
        Write-Host "=== Setting up vcpkg environment ==="
        
        # Copy our vcpkg.json to rustdesk directory
        Write-Host "Copying vcpkg.json to rustdesk directory..."
        $source = "$env:GITHUB_WORKSPACE\vcpkg.json"
        $dest = "$env:GITHUB_WORKSPACE\rustdesk\vcpkg.json"
        
        if (-not (Test-Path $source)) {
          Write-Host "[ERROR] Source vcpkg.json not found: $source"
          exit 1
        }
        
        Copy-Item $source $dest -Force
        Write-Host "[SUCCESS] vcpkg.json copied successfully"
        
    - name: Install vcpkg dependencies
      shell: powershell
      run: |
        Write-Host "=== Installing vcpkg dependencies ==="
        cd "$env:GITHUB_WORKSPACE\rustdesk"
        
        Write-Host "Current directory: $(Get-Location)"
        Write-Host "vcpkg.json content:"
        Get-Content "vcpkg.json" | Write-Host
        
        Write-Host "Running vcpkg install..."
        & "$env:VCPKG_ROOT\vcpkg.exe" install --triplet x64-windows-static --x-install-root="$env:VCPKG_ROOT\installed"
        
        if ($LASTEXITCODE -ne 0) {
          Write-Host "[ERROR] vcpkg install failed with exit code: $LASTEXITCODE"
          Write-Host "=== Checking for error logs ==="
          Get-ChildItem "$env:VCPKG_ROOT" -Filter "*.log" -Recurse | ForEach-Object {
            Write-Host "=== $($_.FullName) ==="
            Get-Content $_.FullName | Write-Host
            Write-Host "========================"
          }
          exit 1
        }
        
        Write-Host "[SUCCESS] vcpkg dependencies installed successfully"
        
    - name: Apply configuration
      shell: powershell
      run: |
        Write-Host "=== Applying configuration ==="
        
        cd "$env:GITHUB_WORKSPACE\rustdesk"
        
        # Create config directory
        New-Item -Path "src\ui" -ItemType Directory -Force -ErrorAction SilentlyContinue | Out-Null
        
        # Write config JSON
        '${{ inputs.config_json }}' | Out-File -FilePath "src\ui\config.json" -Encoding UTF8
        
        # Parse configuration
        try {
          $config = '${{ inputs.config_json }}' | ConvertFrom-Json
        } catch {
          Write-Host "[ERROR] Failed to parse configuration JSON: $($_.Exception.Message)"
          exit 1
        }
        
        # Create simple Rust config file using separate lines
        $rustConfigLines = @()
        $rustConfigLines += "// Auto-generated configuration"
        
        # Server configuration
        $rustConfigLines += "pub const RENDEZVOUS_SERVER: &str = `"$($config.server.RENDEZVOUS_SERVER)`";"
        
        # RELAY_SERVER defaults to RENDEZVOUS_SERVER if not specified
        if ($config.server.RELAY_SERVER -and $config.server.RELAY_SERVER.Length -gt 0) {
          $rustConfigLines += "pub const RELAY_SERVER: &str = `"$($config.server.RELAY_SERVER)`";"
        } else {
          $rustConfigLines += "pub const RELAY_SERVER: &str = `"$($config.server.RENDEZVOUS_SERVER)`";"
        }
        
        if ($config.server.API_SERVER -and $config.server.API_SERVER.Length -gt 0) {
          $rustConfigLines += "pub const API_SERVER: &str = `"$($config.server.API_SERVER)`";"
        } else {
          $rustConfigLines += "pub const API_SERVER: &str = `"`";"
        }
        
        # Map RS_PUB_KEY to KEY for RustDesk compatibility
        $rustConfigLines += "pub const KEY: &str = `"$($config.server.RS_PUB_KEY)`";"
        
        # Branding configuration
        $rustConfigLines += "pub const PRODUCT_NAME: &str = `"$($config.branding.PRODUCT_NAME)`";"
        $rustConfigLines += "pub const APP_NAME: &str = `"$($config.branding.APP_NAME)`";"
        
        # Optional branding fields
        if ($config.branding.COMPANY_NAME -and $config.branding.COMPANY_NAME.Length -gt 0) {
          $rustConfigLines += "pub const COMPANY_NAME: &str = `"$($config.branding.COMPANY_NAME)`";"
        } else {
          $rustConfigLines += "pub const COMPANY_NAME: &str = `"`";"
        }
        
        if ($config.branding.WEBSITE_URL -and $config.branding.WEBSITE_URL.Length -gt 0) {
          $rustConfigLines += "pub const WEBSITE_URL: Option<&str> = Some(`"$($config.branding.WEBSITE_URL)`");"
        } else {
          $rustConfigLines += "pub const WEBSITE_URL: Option<&str> = None;"
        }
        
        if ($config.branding.LOGO_URL -and $config.branding.LOGO_URL.Length -gt 0) {
          $rustConfigLines += "pub const LOGO_URL: Option<&str> = Some(`"$($config.branding.LOGO_URL)`");"
        } else {
          $rustConfigLines += "pub const LOGO_URL: Option<&str> = None;"
        }
        
        if ($config.branding.ICON_URL -and $config.branding.ICON_URL.Length -gt 0) {
          $rustConfigLines += "pub const ICON_URL: Option<&str> = Some(`"$($config.branding.ICON_URL)`");"
        } else {
          $rustConfigLines += "pub const ICON_URL: Option<&str> = None;"
        }
        
        if ($config.branding.WELCOME_TEXT -and $config.branding.WELCOME_TEXT.Length -gt 0) {
          $rustConfigLines += "pub const WELCOME_TEXT: Option<&str> = Some(`"$($config.branding.WELCOME_TEXT)`");"
        } else {
          $rustConfigLines += "pub const WELCOME_TEXT: Option<&str> = None;"
        }
        
        if ($config.branding.SUPPORT_INFO -and $config.branding.SUPPORT_INFO.Length -gt 0) {
          $rustConfigLines += "pub const SUPPORT_INFO: Option<&str> = Some(`"$($config.branding.SUPPORT_INFO)`");"
        } else {
          $rustConfigLines += "pub const SUPPORT_INFO: Option<&str> = None;"
        }
        
        if ($config.branding.SUPPORT_URL -and $config.branding.SUPPORT_URL.Length -gt 0) {
          $rustConfigLines += "pub const SUPPORT_URL: Option<&str> = Some(`"$($config.branding.SUPPORT_URL)`");"
        } else {
          $rustConfigLines += "pub const SUPPORT_URL: Option<&str> = None;"
        }
        
        # Build configuration
        if ($config.build.VERSION -and $config.build.VERSION.Length -gt 0) {
          $rustConfigLines += "pub const VERSION: &str = `"$($config.build.VERSION)`";"
        } else {
          $rustConfigLines += "pub const VERSION: &str = `"1.0.0`";"
        }
        
        if ($config.build.BUILD_DESCRIPTION -and $config.build.BUILD_DESCRIPTION.Length -gt 0) {
          $rustConfigLines += "pub const BUILD_DESCRIPTION: Option<&str> = Some(`"$($config.build.BUILD_DESCRIPTION)`");"
        } else {
          $rustConfigLines += "pub const BUILD_DESCRIPTION: Option<&str> = None;"
        }
        
        $rustConfigLines += "pub const SIGN_EXECUTABLE: bool = $($config.build.SIGN_EXECUTABLE.ToString().ToLower());"
        
        if ($config.build.TARGET_ARCH -and $config.build.TARGET_ARCH.Length -gt 0) {
          $rustConfigLines += "pub const TARGET_ARCH: &str = `"$($config.build.TARGET_ARCH)`";"
        } else {
          $rustConfigLines += "pub const TARGET_ARCH: &str = `"x86_64`";"
        }
        
        # Security configuration
        if ($config.security.PRESET_PASSWORD -and $config.security.PRESET_PASSWORD.Length -gt 0) {
          $rustConfigLines += "pub const PRESET_PASSWORD: Option<&str> = Some(`"$($config.security.PRESET_PASSWORD)`");"
        } else {
          $rustConfigLines += "pub const PRESET_PASSWORD: Option<&str> = None;"
        }
        
        if ($config.security.ACCESS_KEY -and $config.security.ACCESS_KEY.Length -gt 0) {
          $rustConfigLines += "pub const ACCESS_KEY: Option<&str> = Some(`"$($config.security.ACCESS_KEY)`");"
        } else {
          $rustConfigLines += "pub const ACCESS_KEY: Option<&str> = None;"
        }
        
        $rustConfigLines += "pub const PRESET_REMOVE_WALLPAPER: bool = $($config.security.PRESET_REMOVE_WALLPAPER.ToString().ToLower());"
        $rustConfigLines += "pub const PRESET_BLOCK_INPUT: bool = $($config.security.PRESET_BLOCK_INPUT.ToString().ToLower());"
        $rustConfigLines += "pub const PRESET_PRIVACY_MODE: bool = $($config.security.PRESET_PRIVACY_MODE.ToString().ToLower());"
        $rustConfigLines += "pub const PRESET_RECORD_SESSION: bool = $($config.security.PRESET_RECORD_SESSION.ToString().ToLower());"
        
        # Advanced configuration
        if ($config.advanced.CUSTOM_TCP_PORT -and $config.advanced.CUSTOM_TCP_PORT.Length -gt 0) {
          $rustConfigLines += "pub const CUSTOM_TCP_PORT: Option<u16> = Some($($config.advanced.CUSTOM_TCP_PORT));"
        } else {
          $rustConfigLines += "pub const CUSTOM_TCP_PORT: Option<u16> = None;"
        }
        
        if ($config.advanced.CUSTOM_UDP_PORT -and $config.advanced.CUSTOM_UDP_PORT.Length -gt 0) {
          $rustConfigLines += "pub const CUSTOM_UDP_PORT: Option<u16> = Some($($config.advanced.CUSTOM_UDP_PORT));"
        } else {
          $rustConfigLines += "pub const CUSTOM_UDP_PORT: Option<u16> = None;"
        }
        
        $rustConfigLines += "pub const DISABLE_AUDIO: bool = $($config.advanced.DISABLE_AUDIO.ToString().ToLower());"
        $rustConfigLines += "pub const ENABLE_FILE_TRANSFER: bool = $($config.advanced.ENABLE_FILE_TRANSFER.ToString().ToLower());"
        $rustConfigLines += "pub const DISABLE_CLIPBOARD: bool = $($config.advanced.DISABLE_CLIPBOARD.ToString().ToLower());"
        $rustConfigLines += "pub const DEFAULT_VIDEO_QUALITY: &str = `"$($config.advanced.DEFAULT_VIDEO_QUALITY)`";"
        $rustConfigLines += "pub const MAX_FPS: u32 = $($config.advanced.MAX_FPS);"
        $rustConfigLines += "pub const ENABLE_HARDWARE_CODEC: bool = $($config.advanced.ENABLE_HARDWARE_CODEC.ToString().ToLower());"
        $rustConfigLines += "pub const ENABLE_DIRECT_IP_ACCESS: bool = $($config.advanced.ENABLE_DIRECT_IP_ACCESS.ToString().ToLower());"
        
        # Additional advanced options
        if ($config.advanced.CUSTOM_STUN_SERVERS -and $config.advanced.CUSTOM_STUN_SERVERS.Length -gt 0) {
          $rustConfigLines += "pub const CUSTOM_STUN_SERVERS: Option<&str> = Some(`"$($config.advanced.CUSTOM_STUN_SERVERS)`");"
        } else {
          $rustConfigLines += "pub const CUSTOM_STUN_SERVERS: Option<&str> = None;"
        }
        
        $rustConfigLines += "pub const DISABLE_TCP_TUNNELING: bool = $($config.advanced.DISABLE_TCP_TUNNELING.ToString().ToLower());"
        $rustConfigLines += "pub const ENABLE_HARDWARE_ACCELERATION: bool = $($config.advanced.ENABLE_HARDWARE_ACCELERATION.ToString().ToLower());"
        
        if ($config.advanced.AUTO_UPDATE_URL -and $config.advanced.AUTO_UPDATE_URL.Length -gt 0) {
          $rustConfigLines += "pub const AUTO_UPDATE_URL: Option<&str> = Some(`"$($config.advanced.AUTO_UPDATE_URL)`");"
        } else {
          $rustConfigLines += "pub const AUTO_UPDATE_URL: Option<&str> = None;"
        }
        
        # Additional theme and localization settings
        $rustConfigLines += "pub const DEFAULT_THEME: &str = `"$($config.advanced.theme)`";"
        $rustConfigLines += "pub const DEFAULT_LANGUAGE: &str = `"$($config.advanced.lang)`";"
        
        $rustConfigLines | Out-File -FilePath "src\config.rs" -Encoding UTF8
        Write-Host "[SUCCESS] Rust config created"
        
        # Update Cargo.toml carefully - only update if different from rustdesk
        if (Test-Path "Cargo.toml") {
          $cargoContent = Get-Content "Cargo.toml" -Raw
          
          if ($config.branding.APP_NAME -ne "rustdesk") {
            # Update package name
            $cargoContent = $cargoContent -replace 'name = "rustdesk"', "name = `"$($config.branding.APP_NAME)`""
            Write-Host "[SUCCESS] Updated package name in Cargo.toml"
            
            # Update default-run target to match new package name
            $cargoContent = $cargoContent -replace 'default-run = "rustdesk"', "default-run = `"$($config.branding.APP_NAME)`""
            Write-Host "[SUCCESS] Updated default-run target in Cargo.toml"
          }
          
          $cargoContent | Out-File -FilePath "Cargo.toml" -Encoding UTF8
        }
        
        Write-Host "[SUCCESS] Configuration applied successfully"
        
    - name: Generate inline module
      shell: powershell
      run: |
        Write-Host "=== Generating inline UI module ==="
        
        cd "$env:GITHUB_WORKSPACE\rustdesk"
        
        # Check if Python3 is available
        try {
          $pythonVersion = python3 --version
          Write-Host "Python version: $pythonVersion"
        } catch {
          Write-Host "Python3 not found, trying python..."
          try {
            $pythonVersion = python --version
            Write-Host "Python version: $pythonVersion"
          } catch {
            Write-Host "[ERROR] Python not found. Installing Python..."
            choco install python -y
            refreshenv
          }
        }
        
        # Check if the inline script exists
        if (-not (Test-Path "res\inline-sciter.py")) {
          Write-Host "[ERROR] inline-sciter.py script not found in res/ directory"
          Write-Host "Available files in res/ directory:"
          Get-ChildItem "res" -ErrorAction SilentlyContinue | ForEach-Object { Write-Host "  $($_.Name)" }
          Write-Host "Creating a minimal inline.rs module as fallback..."
          
          # Create minimal inline.rs as fallback
          New-Item -Path "src\ui" -ItemType Directory -Force -ErrorAction SilentlyContinue | Out-Null
          $inlineContent = "// Minimal inline module for compilation`n"
          $inlineContent += "#[inline]`n"
          $inlineContent += "pub fn get_index() -> String {`n"
          $inlineContent += '    "<html><head><title>RustDesk</title></head><body><h1>RustDesk Client</h1></body></html>".to_string()`n'
          $inlineContent += "}`n`n"
          $inlineContent += "#[inline]`n"
          $inlineContent += "pub fn get_remote() -> String {`n"
          $inlineContent += '    "<html><head><title>Remote</title></head><body><h1>Remote Control</h1></body></html>".to_string()`n'
          $inlineContent += "}`n`n"
          $inlineContent += "#[inline]`n"
          $inlineContent += "pub fn get_install() -> String {`n"
          $inlineContent += '    "<html><head><title>Install</title></head><body><h1>Installation</h1></body></html>".to_string()`n'
          $inlineContent += "}`n`n"
          $inlineContent += "#[inline]`n"
          $inlineContent += "pub fn get_chatbox() -> String {`n"
          $inlineContent += '    "<html><head><title>Chat</title></head><body><h1>Chat</h1></body></html>".to_string()`n'
          $inlineContent += "}`n`n"
          $inlineContent += "#[inline]`n"
          $inlineContent += "pub fn get_cm() -> String {`n"
          $inlineContent += '    "<html><head><title>Connection Manager</title></head><body><h1>Connection Manager</h1></body></html>".to_string()`n'
          $inlineContent += "}`n"
          $inlineContent | Out-File -FilePath "src\ui\inline.rs" -Encoding UTF8
          Write-Host "[SUCCESS] Created minimal inline.rs module"
        } else {
          Write-Host "Running inline-sciter.py script..."
          if (Get-Command python3 -ErrorAction SilentlyContinue) {
            python3 res\inline-sciter.py
          } else {
            python res\inline-sciter.py
          }
          
          if ($LASTEXITCODE -ne 0) {
            Write-Host "[ERROR] Failed to generate inline module"
            exit 1
          }
          
          Write-Host "[SUCCESS] Generated inline UI module"
        }
        
        # Verify that inline.rs was created
        if (Test-Path "src\ui\inline.rs") {
          Write-Host "[SUCCESS] inline.rs module verified"
          $inlineSize = (Get-Item "src\ui\inline.rs").Length
          Write-Host "inline.rs size: $inlineSize bytes"
        } else {
          Write-Host "[ERROR] inline.rs module was not created"
          exit 1
        }
        
    - name: Build RustDesk
      shell: powershell
      run: |
        Write-Host "=== Building RustDesk ==="
        
        cd "$env:GITHUB_WORKSPACE\rustdesk"
        
        # Set environment variables for build
        $env:VCPKG_ROOT = "C:\vcpkg"
        $env:VCPKG_DEFAULT_TRIPLET = "x64-windows-static"
        $env:LIBCLANG_PATH = "$env:PROGRAMFILES\LLVM\bin"
        $env:RUSTFLAGS = "-C target-feature=+crt-static"
        $env:RUST_BACKTRACE = "1"
        
        # Configure portable mode if enabled
        if ("${{ inputs.enable_portable }}" -eq "true") {
          Write-Host "[PORTABLE] Enabling portable mode..."
          $env:PORTABLE = "1"
          # Set Rust feature for portable build
          $portableFeature = "--features portable"
        } else {
          $portableFeature = ""
        }
        
        Write-Host "Starting Cargo build..."
        if ("${{ inputs.enable_debug }}" -eq "true") {
          Write-Host "Build mode: Debug"
        } else {
          Write-Host "Build mode: Release"
        }
        
        if ("${{ inputs.enable_debug }}" -eq "true") {
          Write-Host "[DEBUG] Building in debug mode..."
          cargo build --features inline $portableFeature --verbose
        } else {
          Write-Host "[RELEASE] Building in release mode..."
          cargo build --release --features inline $portableFeature --verbose
        }
        
        if ($LASTEXITCODE -ne 0) {
          Write-Host "[ERROR] Build failed with exit code $LASTEXITCODE"
          exit $LASTEXITCODE
        }
        
        Write-Host "[SUCCESS] Build completed successfully!"
        
    - name: Prepare artifacts
      shell: powershell
      run: |
        Write-Host "=== Preparing artifacts ==="
        
        cd "$env:GITHUB_WORKSPACE\rustdesk"
        
        try {
          $config = '${{ inputs.config_json }}' | ConvertFrom-Json
        } catch {
          Write-Host "[ERROR] Failed to parse config JSON"
          exit 1
        }
        
        $executableName = "${{ inputs.executable_name }}"
        $buildDir = if ("${{ inputs.enable_debug }}" -eq "true") { "target\debug" } else { "target\release" }
        
        Write-Host "Looking for executable in: $buildDir"
        
        # Find the built executable - search in order of likelihood
        $possibleExes = @(
          "$buildDir\$($config.branding.APP_NAME).exe",
          "$buildDir\rustdesk.exe",
          "$buildDir\RustDesk.exe"
        )
        
        # Add fallback: any .exe file in the build directory
        $allExes = Get-ChildItem $buildDir -Filter "*.exe" -ErrorAction SilentlyContinue
        foreach ($exe in $allExes) {
          $fullPath = "$buildDir\$($exe.Name)"
          if ($fullPath -notin $possibleExes) {
            $possibleExes += $fullPath
          }
        }
        
        $builtExecutable = ""
        foreach ($exe in $possibleExes) {
          if (Test-Path $exe) {
            $builtExecutable = $exe
            Write-Host "[SUCCESS] Found executable: $exe"
            break
          }
        }
        
        if (-not $builtExecutable) {
          Write-Host "[ERROR] No executable found. Available files in ${buildDir}:"
          Get-ChildItem $buildDir -Filter "*.exe" -ErrorAction SilentlyContinue | ForEach-Object { Write-Host "  $($_.Name)" }
          exit 1
        }
        
        # Copy with custom name
        $finalExe = "$buildDir\$executableName.exe"
        if ($builtExecutable -ne $finalExe) {
          Copy-Item $builtExecutable $finalExe -Force
          Write-Host "[SUCCESS] Copied executable to: $finalExe"
        }
        
        # Create installer if requested AND not in portable mode
        $shouldCreateInstaller = if ("${{ inputs.include_installer }}" -ne "") { "${{ inputs.include_installer }}" } else { "${{ inputs.create_installer }}" }
        $isPortableMode = "${{ inputs.enable_portable }}" -eq "true"
        
        if ($shouldCreateInstaller -eq "true" -and -not $isPortableMode) {
          Write-Host "Creating installer..."
          
          # Create installer script file
          $productName = if ($config.branding.PRODUCT_NAME) { $config.branding.PRODUCT_NAME } else { "RustDesk" }
          $productVersion = if ($config.build.VERSION) { $config.build.VERSION } else { "1.0.0" }
          $companyName = if ($config.branding.COMPANY_NAME) { $config.branding.COMPANY_NAME } else { $productName }
          
          $installerContent = @(
            "!define PRODUCT_NAME `"$productName`"",
            "!define PRODUCT_VERSION `"$productVersion`"",
            "!define PRODUCT_PUBLISHER `"$companyName`"",
            "",
            "SetCompressor lzma",
            "RequestExecutionLevel admin",
            "",
            "Name `"`${PRODUCT_NAME}`"",
            "OutFile `"$executableName-installer.exe`"",
            "InstallDir `"`$PROGRAMFILES\`${PRODUCT_NAME}`"",
            "",
            "Section `"MainSection`" SEC01",
            "  SetOutPath `"`$INSTDIR`"",
            "  File `"$buildDir\$executableName.exe`"",
            "  CreateDirectory `"`$SMPROGRAMS\`${PRODUCT_NAME}`"",
            "  CreateShortCut `"`$SMPROGRAMS\`${PRODUCT_NAME}\`${PRODUCT_NAME}.lnk`" `"`$INSTDIR\$executableName.exe`"",
            "  CreateShortCut `"`$DESKTOP\`${PRODUCT_NAME}.lnk`" `"`$INSTDIR\$executableName.exe`"",
            "  WriteUninstaller `"`$INSTDIR\Uninstall.exe`"",
            "SectionEnd",
            "",
            "Section `"Uninstall`"",
            "  Delete `"`$INSTDIR\$executableName.exe`"",
            "  Delete `"`$INSTDIR\Uninstall.exe`"",
            "  Delete `"`$SMPROGRAMS\`${PRODUCT_NAME}\`${PRODUCT_NAME}.lnk`"",
            "  Delete `"`$DESKTOP\`${PRODUCT_NAME}.lnk`"",
            "  RMDir `"`$SMPROGRAMS\`${PRODUCT_NAME}`"",
            "  RMDir `"`$INSTDIR`"",
            "SectionEnd"
          )
          
          $installerContent | Out-File -FilePath "installer.nsi" -Encoding UTF8
          
          # Compile installer
          & "C:\Program Files (x86)\NSIS\makensis.exe" "installer.nsi"
          
          if ($LASTEXITCODE -eq 0) {
            Write-Host "[SUCCESS] Installer created successfully"
          } else {
            Write-Host "⚠️ Installer creation failed, but continuing..."
          }
        } elseif ($isPortableMode) {
          Write-Host "[PORTABLE] Skipping installer creation for portable mode"
          Write-Host "[INFO] Portable executable: $finalExe"
        } else {
          Write-Host "[INFO] Installer creation disabled"
        }
        
        # Display build summary
        Write-Host ""
        Write-Host "=== BUILD SUMMARY ==="
        Write-Host "Mode: $(if ($isPortableMode) { 'Portable' } else { 'Standard' })"
        Write-Host "Debug: ${{ inputs.enable_debug }}"
        Write-Host "Installer: $(if ($shouldCreateInstaller -eq 'true' -and -not $isPortableMode) { 'Yes' } else { 'No' })"
        Write-Host "Executable: $finalExe"
        if (Test-Path "$executableName-installer.exe") {
          Write-Host "Installer: $executableName-installer.exe"
        }
        
        Write-Host "[SUCCESS] Artifacts prepared successfully"
        
    - name: Upload artifacts
      uses: actions/upload-artifact@v4
      with:
        name: rustdesk-client-${{ inputs.executable_name }}
        path: |
          rustdesk/target/debug/*.exe
          rustdesk/target/release/*.exe
          rustdesk/*.exe
        retention-days: 7